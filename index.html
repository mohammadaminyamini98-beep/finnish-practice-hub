<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finnish Practice Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
   <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        /* --- General Styling --- */
        body { background-color: #f0f4f8; color: #1a202c; font-family: 'Poppins', sans-serif; display: flex; justify-content: center; align-items: start; min-height: 100vh; padding: 20px; }
        .main-container { background-color: #ffffff; padding: 30px 40px; border-radius: 20px; width: 500px; max-width: 100%; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        h1 { color: #2c5282; margin-top: 0; font-size: 1.8rem; text-align: center; }

        /* --- Accordion Styling --- */
        .accordion-section { margin-bottom: 15px; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; }
        .accordion-header { background-color: #edf2f7; padding: 18px 25px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .accordion-header h2 { margin: 0; font-size: 1.25rem; color: #2d3748; }
        .accordion-header .icon { font-size: 1.2rem; transition: transform 0.3s ease; }
        .accordion-header.active .icon { transform: rotate(180deg); }
        .accordion-content { background: #fafcff; padding: 25px; display: none; border-top: 1px solid #e2e8f0; }
        
        /* --- 1. Pronunciation Section Styling --- */
        .word-selection { margin: 15px 0; display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
        .word-btn { background-color: #e2e8f0; border: 2px solid transparent; border-radius: 30px; padding: 10px 20px; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; }
        .word-btn.active, .word-btn:hover { background-color: #63b3ed; color: white; border-color: #2c5282; }
        .pronunciation-card { background-color: #edf2f7; padding: 25px; border-radius: 15px; margin: 20px 0; text-align: center; }
        #word-to-say { font-size: 3rem; margin: 0; color: #2d3748; font-weight: 700; }
        #translation { color: #718096; margin: 5px 0 0; }
        .controls { display: flex; justify-content: center; gap: 25px; margin: 25px 0; }
        .control-btn { background-color: #4a5568; border: none; color: #ffffff; width: 70px; height: 70px; border-radius: 50%; font-size: 1.8rem; cursor: pointer; transition: transform 0.2s; display: flex; justify-content: center; align-items: center; }
        .control-btn:hover { transform: scale(1.1); }
        #record-btn.recording { background-color: #e53e3e; animation: pulse 1.5s infinite; }

        /* --- 2. Dictation Section Styling --- */
        .dictation-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap; /* <-- *** FIX #1: Added this to allow items to wrap on small screens *** */
        }
        #dictation-listen-btn { background-color: #3182ce; color: white; font-size: 1.5rem; padding: 15px; border-radius: 50%; width: 60px; height: 60px; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s; }
        #dictation-listen-btn:hover { background-color: #2c5282; }
        #dictation-input { 
            flex-grow: 1; 
            border: 2px solid #cbd5e0; 
            border-radius: 8px; 
            padding: 0 15px; 
            font-size: 1.1rem; 
            font-family: 'Poppins', sans-serif;
            min-width: 150px; /* <-- Added a minimum width to prevent it from getting too small */
        }
        #dictation-input:focus { border-color: #63b3ed; outline: none; }
        #dictation-check-btn { background-color: #38a169; color: white; border: none; border-radius: 8px; padding: 0 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        #dictation-check-btn:hover { background-color: #2f855a; }
        
        #dictation-next-btn {
            background-color: #4a5568;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            display: none; /* Hidden by default */
            margin-top: 10px;
            
            /* --- *** FIX #2: Replaced float: right with modern CSS *** --- */
            display: block;
            width: fit-content; /* Make button only as wide as its text */
            margin-left: auto; /* Push it to the right */
            /* float: right; */ /* <-- Removed this */
        }


        /* --- 3. Sentence Completion Styling --- */
        #sentence-prompt-en { font-size: 1.1rem; color: #4a5568; text-align: center; margin-bottom: 20px; }
        .sentence-build-line { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; } /* <-- Added wrap and justify-content */
        #sentence-prompt-fi { font-size: 1.2rem; color: #2d3748; font-weight: 600; }
        #sentence-input { border: 2px dashed #cbd5e0; border-radius: 8px; padding: 10px 15px; font-size: 1.1rem; font-family: 'Poppins', sans-serif; text-align: center; width: 150px; }
        #sentence-input:focus { border-style: solid; border-color: #63b3ed; outline: none; }
        #sentence-check-btn { background-color: #38a169; color: white; border: none; border-radius: 8px; padding: 12px 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; display: block; width: 100%; }
        #sentence-check-btn:hover { background-color: #2f855a; }

        /* --- General Feedback Styling --- */
        .feedback { padding: 12px; border-radius: 8px; font-weight: 600; min-height: 40px; margin-top: 15px; transition: background-color 0.5s; text-align: left;}
        .feedback.correct { background-color: #c6f6d5; color: #2f855a; }
        .feedback.incorrect { background-color: #fed7d7; color: #c53030; }
        .feedback.listening { background-color: #bee3f8; color: #2b6cb0; text-align: center;}
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(229, 62, 62, 0); } 100% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0); } }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>Finnish Practice Hub</h1>
        
        <div class="accordion-section">
            <div class="accordion-header active" data-target="#pronunciation-content">
                <h2>1. Pronunciation Practice</h2>
                <i class="fas fa-chevron-down icon"></i>
            </div>
            <div class="accordion-content" id="pronunciation-content" style="display: block;">
                <p>Choose a word, then say it out loud:</p>
                <div id="word-selection" class="word-selection"></div>
                <div class="pronunciation-card">
                    <h2 id="word-to-say">...</h2>
                    <p id="translation">...</p>
                </div>
                <div class="controls">
                    <button id="speak-btn" class="control-btn" title="Listen"><i class="fas fa-volume-up"></i></button>
                    <button id="record-btn" class="control-btn" title="Record your voice"><i class="fas fa-microphone"></i></button>
                </div>
                <div id="feedback-message" class="feedback"></div>
            </div>
        </div>

        <div class="accordion-section">
            <div class="accordion-header" data-target="#dictation-content">
                <h2>2. Dictation Practice</h2>
                <i class="fas fa-chevron-down icon"></i>
            </div>
            <div class="accordion-content" id="dictation-content">
                <p>Listen to the phrase, then type what you hear:</p>
                <div class="dictation-controls">
                    <button id="dictation-listen-btn" title="Listen to Phrase"><i class="fas fa-volume-up"></i></button>
                    <input type="text" id="dictation-input" placeholder="Type in Finnish...">
                    <button id="dictation-check-btn">Check</button>
                </div>
                <div id="dictation-feedback" class="feedback"></div>
                <button id="dictation-next-btn">Next Phrase <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <div class="accordion-section">
            <div class="accordion-header" data-target="#sentence-content">
                <h2>3. Sentence Completion</h2>
                <i class="fas fa-chevron-down icon"></i>
            </div>
            <div class="accordion-content" id="sentence-content">
                <p>Complete the Finnish sentence. Fill in the blank!</p>
                <p id="sentence-prompt-en">I am buying an <strong>apple</strong>.</p>
                <div class="sentence-build-line">
                    <span id="sentence-prompt-fi">MinÃ¤ ostan</span>
                    <input type="text" id="sentence-input" placeholder="...">
                    <span>.</span>
                </div>
                <button id="sentence-check-btn">Check Answer</button>
                <div id="sentence-feedback" class="feedback"></div>
            </div>
        </div>

<!-- 4. Rate & Reflect (INLINE CSS/JS FRIENDLY) -->
        <div class="accordion-section">
          <div class="accordion-header" data-target="#feedback-content">
            <h2>4. Rate & Reflect</h2>
            <i class="fas fa-chevron-down icon"></i>
          </div>
          <div class="accordion-content" id="feedback-content">
            <p>How much did you like this game?</p>

            <div id="star-group" role="radiogroup" aria-label="Star rating"
                 style="display:flex;gap:8px;justify-content:center;margin:8px 0 10px;">
              <button type="button" aria-label="1 star" data-value="1"
                      style="background:#edf2f7;border:2px solid #e2e8f0;width:44px;height:44px;border-radius:50%;display:grid;place-items:center;cursor:pointer;transition:transform .15s, background .15s, border-color .15s;">
                <i class="fa-regular fa-star" style="font-size:1.25rem;"></i>
              </button>
              <button type="button" aria-label="2 stars" data-value="2"
                      style="background:#edf2f7;border:2px solid #e2e8f0;width:44px;height:44px;border-radius:50%;display:grid;place-items:center;cursor:pointer;transition:transform .15s, background .15s, border-color .15s;">
                <i class="fa-regular fa-star" style="font-size:1.25rem;"></i>
              </button>
              <button type="button" aria-label="3 stars" data-value="3"
                      style="background:#edf2f7;border:2px solid #e2e8f0;width:44px;height:44px;border-radius:50%;display:grid;place-items:center;cursor:pointer;transition:transform .15s, background .15s, border-color .15s;">
                <i class="fa-regular fa-star" style="font-size:1.25rem;"></i>
              </button>
              <button type="button" aria-label="4 stars" data-value="4"
                      style="background:#edf2f7;border:2px solid #e2e8f0;width:44px;height:44px;border-radius:50%;display:grid;place-items:center;cursor:pointer;transition:transform .15s, background .15s, border-color .15s;">
                <i class="fa-regular fa-star" style="font-size:1.25rem;"></i>
              </button>
              <button type="button" aria-label="5 stars" data-value="5"
                      style="background:#edf2f7;border:2px solid #e2e8f0;width:44px;height:44px;border-radius:50%;display:grid;place-items:center;cursor:pointer;transition:transform .15s, background .15s, border-color .15s;">
                <i class="fa-regular fa-star" style="font-size:1.25rem;"></i>
              </button>
            </div>

            <div style="text-align:center;color:#4a5568;margin-bottom:12px;">
              <strong><span id="avg-rating">0.0</span>/5</strong>
              Â· <span id="total-votes">0</span> votes
            </div>

            <textarea id="feedback-comment" rows="3" placeholder="Optional: What worked? What should we improve?"
                      style="width:100%;border:2px solid #cbd5e0;border-radius:10px;padding:10px 12px;font-family:'Poppins',sans-serif;font-size:1rem;"></textarea>

            <div style="display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:10px;">
              <button id="submit-feedback"
                      style="background-color:#2b6cb0;color:#fff;border:none;border-radius:10px;padding:10px 18px;font-weight:600;cursor:pointer;">
                Submit
              </button>
              <span id="submit-status" style="font-size:.95rem;color:#4a5568;opacity:.85;"></span>
            </div>
          </div>
        </div>
        <!-- End Rate & Reflect -->

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // === 0. SHARED FUNCTION ===
            function speakFinnish(phrase) {
                window.speechSynthesis.cancel(); 
                const utterance = new SpeechSynthesisUtterance(phrase);
                utterance.lang = 'fi-FI';
                window.speechSynthesis.speak(utterance);
            }

            // === 1. PRONUNCIATION DATA & LOGIC ===
            const pronunciationData = [
                {
                    "correct": "Tomaatti",
                    "translation": "Tomato",
                    "mistakes": {
                        "tomati": "So close! You missed the long 'aa' and the double 'tt'. In Finnish, hold those sounds a bit longer. To-maaat-ti.",
                        "domaatti": "Good try! Remember the first letter makes a sharp 'T' sound, not a soft 'D' sound.",
                        "tomaati": "Almost there! The double 'tt' in the middle should be a quick, sharp stop. Try to pause for a split second. To-maat-ti.",
                        "tomaatto": "Great pronunciation! Just be careful with the ending. It finishes with a clean 'i' sound, not 'o'.",
                        "tomatti": "You got the double 'tt' perfect! Now just lengthen the 'a' sound before it: To-maaa-tti.",
                        "tomatit": "That's the plural form, 'tomatoes'! You said it perfectly. For just one 'tomato', the word is 'Tomaatti'.",
                        "tomaattia": "Excellent! That's the partitive case, used when you're eating a tomato. The basic word is 'Tomaatti'.",
                        "tomaatin": "Spot on! That's the genitive case, meaning 'tomato's'. To just say 'tomato', it's 'Tomaatti'.",
                        "tomaatissa": "Perfect grammar! That means 'in the tomato'. The basic noun is 'Tomaatti'.",
                        "timantti": "That's a different word! 'Timantti' means 'diamond'. They sound similar, but for 'tomato', the first vowel is 'o'. To-maa-tti.",
                        "tuomari": "That sounds like 'tuomari', which means 'judge'. A very different thing! Focus on the 'To-maa' start.",
                        "toomatti": "Careful with which vowel you lengthen! The 'o' is short, but the 'a' is long. Try: To-maatti.",
                        "tomaat": "You're so close, don't forget the ending! It needs a '-ti' at the end. Tomaat-ti.",
                        "tomaatte": "You got the rhythm right! Just the last vowel is off. It should be a clear 'i' sound, like in 'ski'.",
                        "tomattiin": "Another perfect grammatical form! That means 'into the tomato'. The base word is 'Tomaatti'.",
                        "taamotti": "It sounds like the sounds are swapped around. The order is T-O-M-A-A-T-T-I.",
                        "tomayto": "That sounds like the English pronunciation. In Finnish, every letter gets a clear, distinct sound. To-ma-at-ti.",
                        "somaatti": "Almost! The first sound is a 'T', not an 'S'. It's a hard tap of the tongue behind your teeth.",
                        "tomasky": "An interesting try! The ending is a simple '-aatti'. Let's try it again: To-ma-at-ti.",
                        "matto": "That's another Finnish word, 'matto' for 'rug' or 'mat'. 'Tomaatti' is much longer!"
                    }
                },
                {
                    "correct": "Omena",
                    "translation": "Apple",
                    "mistakes": {
                        "amena": "Almost! Make sure you start with a clear 'O' sound, like in the word 'open'.",
                        "omina": "Very close! The middle vowel is 'e' (like in 'egg'), not 'i'. Try: O-me-na.",
                        "omeno": "You've got the beginning perfect! The word ends with an 'a' sound, like the 'a' in 'father'. O-me-na.",
                        "omenaa": "This is a correct form called the partitive! You'd use it to say 'I'm eating an apple'. For 'an apple', it's just 'Omena'.",
                        "omenat": "You said 'apples' (plural)! Perfect pronunciation. For the singular 'apple', just say 'Omena'.",
                        "ommena": "Great try! The 'm' sound is single and quick, not held. O-me-na.",
                        "onnena": "That sounds like 'onnena', which means 'as happiness'. For 'apple', use a soft 'm' sound: O-me-na.",
                        "oomena": "Careful! The 'o' at the beginning is short and sharp. It's O-mena, not OO-mena.",
                        "omela": "So close! The middle consonant is an 'n' sound, not an 'l'. O-me-na.",
                        "omana": "That's a real word meaning 'as one's own'! For 'apple', the middle sound is 'me', not 'ma'. O-me-na.",
                        "omen": "That's the English word 'omen'. The Finnish word needs an 'a' at the end: O-me-na.",
                        "omenan": "Perfect genitive case! That means 'apple's'. The basic word is just 'Omena'.",
                        "omenassa": "Flawless grammar! That means 'in the apple'. The standalone word is 'Omena'.",
                        "umena": "Good effort! The first sound is 'o', not 'u'. Try to make your lips a round 'O' shape.",
                        "omenaiva": "That's a creative guess! The word is simpler, just three syllables: O-me-na.",
                        "onema": "The 'm' and 'n' are switched! Try it this way: O-me-na.",
                        "omenae": "A classic English speaker mistake! In Finnish, 'a' at the end is always a clean 'ah' sound, never 'ay' or 'ae'.",
                        "emona": "You missed the first letter! It starts with a clear 'O'.",
                        "omppu": "Aha! You found the common slang word for apple! That's correct informally. The standard word is 'Omena'.",
                        "ihana": "That means 'wonderful'! It has a similar rhythm, but the word for apple is 'Omena'."
                    }
                },
                {
                    "correct": "Porkkana",
                    "translation": "Carrot",
                    "mistakes": {
                        "porkana": "Great effort! In the middle, the double 'kk' needs a stronger, sharper sound. Try: Pork-ka-na.",
                        "borkkana": "You're almost there! The first sound is a 'P', not a 'B'. Make a little puff of air when you say it.",
                        "purkkana": "Watch out for that first vowel! It's an 'o' sound, like in 'more'. Keep your lips rounded. Pork-ka-na.",
                        "porkkanna": "So close! The double consonant is 'kk' in the middle. The 'n' at the end is single. Pork-ka-na.",
                        "pokkana": "You missed the 'r' sound! Make sure you get that little roll in there after the 'o'. Por-kka-na.",
                        "poro": "Close start! But 'poro' means reindeer! To say 'carrot', you need to add the '-kkana' part.",
                        "kana": "You said the last part! 'Kana' means 'chicken'. The whole word for carrot is 'Porkkana'.",
                        "porkkanat": "Perfect plural! That means 'carrots'. For a single carrot, it's 'Porkkana'.",
                        "porkkanaa": "Excellent partitive case! Used when you're nibbling on a carrot. The base word is 'Porkkana'.",
                        "porkkanan": "You said 'carrot's', the genitive case. Flawless! The simple noun is 'Porkkana'.",
                        "poorkkana": "The 'o' sound is short and quick. It's Por-kkana, not Poor-kkana.",
                        "porkkala": "Watch out for the last consonant! It's an 'n', not an 'l'. Pork-ka-na.",
                        "porgana": "This is a double mistake! The 'kk' should be a sharp double sound, not a 'g', and the 'n' is single.",
                        "parkkana": "It sounds like 'parka', which means 'poor thing'. For carrot, it's a clear 'o' sound. Porkkana.",
                        "kurkkuna": "Tricky! That means 'as a cucumber'. Very similar ending, but the word for carrot is 'Porkkana'.",
                        "peruna": "That's another vegetable! 'Peruna' is potato. 'Porkkana' is carrot.",
                        "porkkana in": "It sounds like you're adding an English word. The Finnish word ends with a clean '-na'.",
                        "gorggala": "Let's work on the sounds. It starts with a 'P', has an 'r' roll, a double 'kk', and ends in '-na'.",
                        "porgand": "That's 'carrot' in Estonian! Very close language, but in Finnish, it's 'Porkkana'.",
                        "morot": "That means 'hi' informally and is also the plural of the Swedish word for carrot! In Finnish, it's 'Porkkana'."
                    }
                },
                {
                    "correct": "Vesimeloni",
                    "translation": "Watermelon",
                    "mistakes": {
                        "vesimeloni": "That's it! Perfect!",
                        "vesimelon": "You got all the hard parts! Just remember to add the 'i' sound at the very end. Ve-si-me-lo-ni.",
                        "visimeloni": "Excellent try! The very first vowel is 'e', like in the English word 'vet'. Ve-si-me-lo-ni.",
                        "wesimeloni": "You're saying it beautifully! For a perfect Finnish 'v', gently touch your top teeth to your bottom lip, like in 'victory'.",
                        "meloni": "You got half of it! 'Meloni' is just 'melon'. To say 'watermelon', you add the word for water, 'vesi', at the front.",
                        "vesi": "That's the first part, which means 'water'. Now add the second part: 'meloni'.",
                        "vesimelonia": "Perfect grammar for saying 'some watermelon'! If you just want to name the fruit, the basic form is 'vesimeloni'.",
                        "vesimelonit": "You said 'watermelons' (plural)! Perfect pronunciation. For the singular, it's 'vesimeloni'.",
                        "melonivesi": "A clever guess! You have the right parts, 'vesi' (water) and 'meloni' (melon), but in the wrong order. It's 'Vesimeloni'.",
                        "vesimelooni": "Careful with the length! All the vowels in 'meloni' are short. Ve-si-me-lo-ni.",
                        "vesimelona": "Almost at the finish line! The word ends with an 'i' sound, not an 'a'.",
                        "vasimeloni": "So close! Remember it's a 've' sound, not 'va'. Vesi means water.",
                        "vesimelone": "The ending should be a sharp 'i' sound, like 'ee' in 'see', but shorter.",
                        "fesimeloni": "Good try! The 'v' sound is made with the teeth and lip, not an 'f' sound made just with the lip.",
                        "vesimelonin": "You've got the genitive case, 'watermelon's'! The basic noun is 'vesimeloni'.",
                        "vesimeloniassa": "That's an interesting combination. The word is 'vesimeloni' and 'in a watermelon' would be 'vesimelonissa'.",
                        "vesimelo": "You started strong but didn't finish! Don't forget the '-ni' at the end.",
                        "vesimuna": "That's a funny mix! It sounds like 'vesi' (water) + 'muna' (egg). Water-egg! Remember it's 'meloni', not 'muna'.",
                        "siemen": "That means 'seed'! I can see why you'd think that. The middle of 'vesimeloni' sounds a bit like it.",
                        "vesimeloniemi": "A creative ending! The correct word is simpler. It just ends with 'meloni'."
                    }
                }
            ];

            const wordSelectionContainer = document.getElementById('word-selection');
            const wordToSayElem = document.getElementById('word-to-say');
            const translationElem = document.getElementById('translation');
            const speakBtn = document.getElementById('speak-btn');
            const recordBtn = document.getElementById('record-btn');
            const feedbackMessageElem = document.getElementById('feedback-message');
            let currentPronunciationWord = null;

            const levenshteinDistance = (a, b) => {
                const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
                for (let i = 0; i <= a.length; i += 1) { matrix[0][i] = i; }
                for (let j = 0; j <= b.length; j += 1) { matrix[j][0] = j; }
                for (let j = 1; j <= b.length; j += 1) {
                    for (let i = 1; i <= a.length; i += 1) {
                        const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
                        matrix[j][i] = Math.min(matrix[j][i - 1] + 1, matrix[j - 1][i] + 1, matrix[j - 1][i - 1] + indicator);
                    }
                }
                return matrix[b.length][a.length];
            };
            
            pronunciationData.forEach(wordObj => {
                const btn = document.createElement('button');
                btn.className = 'word-btn';
                btn.textContent = wordObj.correct;
                btn.onclick = () => selectPronunciationWord(wordObj);
                wordSelectionContainer.appendChild(btn);
            });

            function selectPronunciationWord(wordObj) {
                currentPronunciationWord = wordObj;
                wordToSayElem.textContent = wordObj.correct;
                translationElem.textContent = `(English: ${wordObj.translation})`;
                feedbackMessageElem.innerHTML = '';
                feedbackMessageElem.className = 'feedback';
                document.querySelectorAll('.word-btn').forEach(b => {
                    b.classList.toggle('active', b.textContent === wordObj.correct);
                });
            }

            selectPronunciationWord(pronunciationData[0]);

            speakBtn.addEventListener('click', () => {
                if (!currentPronunciationWord) return;
                speakFinnish(currentPronunciationWord.correct); 
            });

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                const recognition = new SpeechRecognition();
                recognition.lang = 'fi-FI';
                recognition.continuous = false;
                
                recordBtn.addEventListener('click', () => { 
                    if (!currentPronunciationWord) return; 
                    try { recognition.start(); } catch(e) { console.error("Recognition failed to start.", e); }
                });

                recognition.onstart = () => {
                    recordBtn.classList.add('recording');
                    feedbackMessageElem.textContent = 'Listening...';
                    feedbackMessageElem.className = 'feedback listening';
                };

                recognition.onend = () => recordBtn.classList.remove('recording');

                recognition.onresult = (event) => { 
                    const userSaid = event.results[0][0].transcript.toLowerCase().trim().replace(/[.,!?]/g, '');
                    const correctWord = currentPronunciationWord.correct.toLowerCase();
                    if (userSaid === correctWord) {
                        feedbackMessageElem.innerHTML = 'Perfect! You got it exactly right! ðŸŽ‰';
                        feedbackMessageElem.className = 'feedback correct';
                        return;
                    }
                    if (currentPronunciationWord.mistakes[userSaid]) {
                        feedbackMessageElem.innerHTML = `ðŸ’¡ <strong>Tip:</strong> ${currentPronunciationWord.mistakes[userSaid]}`;
                        feedbackMessageElem.className = 'feedback incorrect';
                        return;
                    }
                    let bestMatch = null, minDistance = 3;
                    for (const mistake in currentPronunciationWord.mistakes) {
                        const distance = levenshteinDistance(userSaid, mistake);
                        if (distance < minDistance) { minDistance = distance; bestMatch = mistake; }
                    }
                    if (bestMatch) {
                        feedbackMessageElem.innerHTML = `ðŸ’¡ <strong>Tip:</strong> That sounded like "<em>${userSaid}</em>". ${currentPronunciationWord.mistakes[bestMatch]}`;
                    } else {
                        feedbackMessageElem.innerHTML = `You said "<strong>${userSaid}</strong>". That's not quite right. Listen carefully and try again.`;
                    }
                    feedbackMessageElem.className = 'feedback incorrect';
                };

                recognition.onerror = (event) => { 
                    let errorMessage = "An error occurred. Please try again.";
                    if (event.error === 'no-speech') {
                        errorMessage = "I didn't hear anything. Try speaking a little louder!";
                    } else if (event.error === 'not-allowed') {
                        errorMessage = "You need to allow microphone access to practice.";
                    }
                    feedbackMessageElem.textContent = errorMessage;
                    feedbackMessageElem.className = 'feedback incorrect';
                };
            } else {
                alert("Sorry, your browser doesn't support Speech Recognition. Please use Google Chrome or Microsoft Edge.");
                recordBtn.style.display = 'none';
            }

            // === 2. ACCORDION LOGIC ===
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = document.querySelector(header.dataset.target);
                    const wasActive = header.classList.contains('active');
                    
                    document.querySelectorAll('.accordion-content').forEach(c => c.style.display = 'none');
                    document.querySelectorAll('.accordion-header').forEach(h => h.classList.remove('active'));

                    if (!wasActive) {
                        content.style.display = 'block';
                        header.classList.add('active');

                        if (header.dataset.target === '#dictation-content') {
                            speakFinnish(currentDictationPhrase.correct);
                            dictationInput.focus();
                        } else if (header.dataset.target === '#sentence-content') {
                            sentenceInput.focus();
                        }
                    }
                });
            });

            // === 3. DICTATION DATA & LOGIC ===
            const dictationData = [
                {
                    "correct": "MinÃ¤ ostan omenan",
                    "translation": "I am buying an apple",
                    "mistakes": {
                        "minÃ¤ ostan omena": "So close! When you 'buy an apple', the object 'omena' needs the 'n' at the end. Try: ome-nan.",
                        "mina ostan omenan": "Great sentence! Just remember the 'Ã¤' in 'minÃ¤' has an 'aah' sound, like in 'cat'. Try: Mi-nÃ¤."
                    }
                },
                {
                    "correct": "Yksi tomaatti, kiitos",
                    "translation": "One tomato, please",
                    "mistakes": {
                        "yksi tomaatti kitos": "Almost perfect! The word 'kiitos' (please/thank you) has a long 'ii' sound. Hold it a bit longer: Kiii-tos.",
                        "yksi tomaatti kiitoks": "Careful with the ending! No 's' at the end of 'kiitos'."
                    }
                },
                {
                    "correct": "MissÃ¤ porkkanat ovat?",
                    "translation": "Where are the carrots?",
                    "mistakes": {
                        "missÃ¤ porkkanat ovat": "Perfect spelling, well done!",
                        "missÃ¤ porkkana ovat": "Almost! Since you're asking 'where *are*', the word 'carrot' needs to be plural: 'porkkanat'.",
                        "missa porkkanat ovat": "You forgot the special letter! 'MissÃ¤' (where) needs the 'Ã¤' sound."
                    }
                },
                {
                    "correct": "Vesimeloni on kallis",
                    "translation": "The watermelon is expensive",
                    "mistakes": {
                        "vesimeloni on kalis": "Very close! 'Expensive' is 'kallis' with two 'l's. Hold that 'l' sound."
                    }
                }
            ];

            const dictationListenBtn = document.getElementById('dictation-listen-btn');
            const dictationInput = document.getElementById('dictation-input');
            const dictationCheckBtn = document.getElementById('dictation-check-btn');
            const dictationFeedback = document.getElementById('dictation-feedback');
            const dictationNextBtn = document.getElementById('dictation-next-btn');

            let currentDictationIndex = 0;
            let currentDictationPhrase = dictationData[currentDictationIndex];

            dictationListenBtn.addEventListener('click', () => {
                speakFinnish(currentDictationPhrase.correct);
            });

            dictationCheckBtn.addEventListener('click', () => { 
                // **FIX #1: Removed the extra dot**
                const userInput = dictationInput.value.toLowerCase().trim().replace(/[.,!?]/g, '');
                const correctText = currentDictationPhrase.correct.toLowerCase().trim().replace(/[.,!?]/g, '');
                
                dictationNextBtn.style.display = 'inline-block';
                if (userInput === correctText) {
                    dictationFeedback.innerHTML = `TÃ¤ydellistÃ¤! (Perfect!)<br><strong>Correct:</strong> ${currentDictationPhrase.correct}`;
                    dictationFeedback.className = 'feedback correct';
                } else if (currentDictationPhrase.mistakes[userInput]) {
                    dictationFeedback.innerHTML = `ðŸ’¡ <strong>Tip:</strong> ${currentDictationPhrase.mistakes[userInput]}`;
                    dictationFeedback.className = 'feedback incorrect';
                } else {
                    dictationFeedback.innerHTML = `You typed "<strong>${dictationInput.value}</strong>".<br><strong>Correct was:</strong> ${currentDictationPhrase.correct}`;
                    dictationFeedback.className = 'feedback incorrect';
                }
            });

            dictationNextBtn.addEventListener('click', () => { 
                currentDictationIndex = (currentDictationIndex + 1) % dictationData.length;
                currentDictationPhrase = dictationData[currentDictationIndex];
                dictationInput.value = '';
                dictationFeedback.innerHTML = '';
                dictationFeedback.className = 'feedback';
                dictationNextBtn.style.display = 'none';
                speakFinnish(currentDictationPhrase.correct);
            });
            
            dictationInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') { event.preventDefault(); dictationCheckBtn.click(); }
            });

            // === 4. SENTENCE COMPLETION LOGIC ===
            const sentenceData = [
                {
                    prompt_en: "I am buying an <strong>apple</strong>.",
                    prompt_fi_start: "MinÃ¤ ostan",
                    correct_answer: "omenan",
                    full_sentence_fi: "MinÃ¤ ostan omenan",
                    hint: "Good try! When you buy a whole 'omena', it changes to 'omenan' (accusative case)."
                },
                {
                    prompt_en: "I am buying a <strong>tomato</strong>.",
                    prompt_fi_start: "MinÃ¤ ostan",
                    correct_answer: "tomaatin",
                    full_sentence_fi: "MinÃ¤ ostan tomaatin",
                    hint: "Almost! 'Tomaatti' changes to 'tomaatin' in this sentence."
                },
                {
                    prompt_en: "I am buying a <strong>carrot</strong>.",
                    prompt_fi_start: "MinÃ¤ ostan",
                    correct_answer: "porkkanan",
                    full_sentence_fi: "MinÃ¤ ostan porkkanan",
                    hint: "Close! 'Porkkana' needs an '-n' at the end here, becoming 'porkkanan'."
                },
                {
                    prompt_en: "I am buying a <strong>watermelon</strong>.",
                    prompt_fi_start: "MinÃ¤ ostan",
                    correct_answer: "vesimelonin",
                    full_sentence_fi: "MinÃ¤ ostan vesimelonin",
                    hint: "Nearly there! 'Vesimeloni' changes to 'vesimelonin' when you buy it."
                }
            ];

            const sentencePromptEn = document.getElementById('sentence-prompt-en');
            const sentencePromptFi = document.getElementById('sentence-prompt-fi');
            const sentenceInput = document.getElementById('sentence-input');
            const sentenceCheckBtn = document.getElementById('sentence-check-btn');
            // **FIX #2: Corrected the ID name**
            const sentenceFeedback = document.getElementById('sentence-feedback'); 

            let currentSentenceIndex = 0;

            function loadSentence(index) {
                const currentSentence = sentenceData[index];
                sentencePromptEn.innerHTML = currentSentence.prompt_en;
                sentencePromptFi.textContent = currentSentence.prompt_fi_start;
                sentenceInput.value = '';
                sentenceFeedback.innerHTML = '';
                sentenceFeedback.className = 'feedback';
                sentenceCheckBtn.disabled = false;
                sentenceInput.disabled = false;
                sentenceInput.focus();
            }

            sentenceCheckBtn.addEventListener('click', () => {
                const userInput = sentenceInput.value.toLowerCase().trim().replace(/[.,!?]/g, '');
                const currentSentence = sentenceData[currentSentenceIndex];
                const correctAnswer = currentSentence.correct_answer;

                if (userInput === correctAnswer) {
                    sentenceFeedback.innerHTML = `Oikein! (Correct!) Listening to the full sentence: <br><strong>${currentSentence.full_sentence_fi}</strong>`;
                    sentenceFeedback.className = 'feedback correct';
                    
                    speakFinnish(currentSentence.full_sentence_fi);

                    sentenceCheckBtn.disabled = true;
                    sentenceInput.disabled = true;

                    setTimeout(() => {
                        currentSentenceIndex = (currentSentenceIndex + 1) % sentenceData.length;
                        loadSentence(currentSentenceIndex);
                    }, 2500); // Wait 2.5 seconds before loading next

                } else {
                    sentenceFeedback.innerHTML = `ðŸ’¡ <strong>Hint:</strong> ${currentSentence.hint}`;
                    sentenceFeedback.className = 'feedback incorrect';
                }
            });

            sentenceInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    sentenceCheckBtn.click();
                }
            });

            // Load the first sentence
            loadSentence(currentSentenceIndex);
        });
    </script>
</body>
</html>


